CFLAGS=

# Run like "make DEBUG=1 ..." to turn on debugging symbols
DEBUG ?= 0
ifeq ($(DEBUG), 1)
	CFLAGS=-g3 -ggdb3 -DDEBUG -O0
endif

CC=gcc
CFLAGS+=-Wall
CFLAGS+=-Wextra
CFLAGS+=-pedantic
CFLAGS+=-Iunity

# Automatically generate dependencies. -MMD generates non-system header
# dependencies. -MP creates an empty rule for generating each dependency. See
# http://www.microhowto.info/howto/automatically_generate_makefile_dependencies.html
CPPFLAGS+=-MMD -MP

SRC=$(wildcard assembler/*.c)
SRC+=$(wildcard unity/*.c)
SRC_O=$(SRC:%.c=%.o)

.PHONY: all
all: bin/assembler

.PHONY: test
test: bin/assembler_parser_test
	./bin/assembler_parser_test

bin/assembler: assembler/assembler.o assembler/parser.o assembler/substring.o
	$(CC) -o $@ $^

bin/assembler_parser_test: assembler/parser_test.o assembler/substring.o unity/unity.o
	$(CC) -o $@ $^

# Remember, .o dependencies are autogenerated from gcc because of -MMD and -MP
# and our include at the bottom of this file.
$(SRC_O): %.o: %.c
	$(CC) $(CPPFLAGS) $(CFLAGS) -c -o $@ $<

.PHONY: clean
clean:
	git clean -xfd

# Include all of the dependency files generated from -MD and -MP. Purposely at
# the bottom of this Makefile so these don't supersede the default target on
# accident.
-include $(SRC:%.c=%.d)
